{"remainingRequest":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\src\\views\\content\\create\\release.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\src\\views\\content\\create\\release.vue","mtime":1574160264869},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1558492728398},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\babel-loader\\lib\\index.js","mtime":1558492720858},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1558492728398},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\vue-loader\\lib\\index.js","mtime":1558492728890}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport Article from '@/views/content/create/components/Article'\nimport Atlas from '@/views/content/create/components/Atlas'\nimport Video from '@/views/content/create/components/Video'\nexport default {\n  name: 'release',\n  // 组件\n  components: {\n    'my-article': Article,\n    'my-atlas': Atlas,\n    'my-video': Video\n  },\n  // 数据\n  data() {\n    return {\n      tabs: [\n        {type: '4', name: 'myArticle'},\n        {type: '3', name: 'myAtlas'},\n        {type: '2', name: 'videoSmall'},\n        {type: '1', name: 'video'}\n      ],\n      // 提交表单\n      formData: {\n        // 类型\n        contentType: '',     // 4 文章发布  3 图集发布   2 小视频发布  1 视频发布\n        // 标题\n        title: '',\n        //副标题\n        smallTitle: '',\n        // 封面\n        coverList: [],\n        // 分类\n        contentCategory:[],\n        // 标签\n        tagList: [],\n        // 地狱\n        region: '',\n        regions: [],\n        // 商品链接\n        relationInfoList:[],\n        relationInfo: '',\n        // 是否草稿\n        contentStatus: '',\n        // 是否定时\n        isTime: 0,\n        // 定时时间\n        pubDate: '',\n\n        // 文章\n        // 富文本信息\n        article: {\n          content:''\n        },\n\n        // 图集\n        atlasList: [],\n\n        // 视频\n        // 是否素材\n        libraryId: '',\n        videoInfoParams:{\n          info: null\n        },\n        mediaUrl: '',\n        fileId: ''\n      },\n      timeDialog: false,\n      rules: {\n        pubDate: [\n          {required: true, message: '请选择发布时间', trigger: 'blur'}\n        ]\n      },\n\n      // 默认显示的tabs\n      activeName: '',\n      editId: null\n    }\n  },\n  created(){\n    this.editId =  this.$route.query.id\n    if(this.editId){\n      this.getDetails()\n    }else{\n      this.activeName = 'myArticle'\n      this.formData.contentType = '4'\n    }\n  },\n  // 初始化数据\n  mounted() {\n    this.$nextTick(() => {\n\n    })\n  },\n  // keepAlive 页面显示时\n  activated() {\n    this.getTableList();\n  },\n  // 方法\n  methods: {\n    init(){\n      this.formDataInit()\n     /* this.$nextTick(()=>{\n\n      })*/\n     setTimeout(()=>{\n       if(this.$refs[this.activeName]){\n         this.$refs[this.activeName].init()\n       }\n     },0)\n    },\n    formDataInit(){\n      // 初始化数据\n      this.formData = {\n        // 类型\n        contentType: this.formData.contentType,     // 4 文章发布  3 图集发布   2 小视频发布  1 视频发布\n        // 标题\n        title: '',\n        //副标题\n        smallTitle: '',\n        // 封面\n        coverList: [],\n        // 分类\n        contentCategory:[],\n        // 标签\n        tagList: [],\n        // 地狱\n        region: '',\n        regions: [],\n        // 商品链接\n        relationInfoList:[],\n        relationInfo: '',\n        // 是否草稿\n        contentStatus: '',\n        // 是否定时\n        isTime: 0,\n        // 定时时间\n        pubDate: '',\n        // 文章\n        // 富文本信息\n        article: {\n          content:''\n        },\n        // 图集\n        atlasList: [],\n        // 视频\n        // 是否素材\n        libraryId: '',\n        videoInfoParams:{\n          info: null\n        },\n        mediaUrl: '',\n        fileId: ''\n      }\n    },\n    async handleBeforeClick(activeName, oldActiveName){\n      if(!oldActiveName || oldActiveName == '0'){\n        return true\n      }else{\n        let activeItem = this.tabs.find(item => {\n          return activeName == item.name\n        })\n        if(this.editId){\n          const flag = await this.$confirm('点击确认视为放弃本次编辑，开始其他类型的发布', '切换', {\n            confirmButtonText: '确认',\n            cancelButtonText: '取消',\n            showClose:false\n          });\n          if(flag){\n            this.formData.id = null\n            this.editId = null\n            this.formData.contentType = activeItem.type\n            this.$route.query.id = null\n            this.init()\n            return true\n          }else{\n            return false\n          }\n        }else{\n          this.formData.contentType = activeItem.type\n          this.init()\n          return true\n        }\n      }\n    },\n    // 确认定时\n    timeDialogSub(){\n      this.$refs.pubDateForm.validate((valid) => {\n        if (valid) {\n          this.formData.isTime = 1\n          this.contentSave(true);\n        } else {\n          return false;\n        }\n      });\n    },\n    // 发布\n    contentSave(state){\n      if(!this.formData.title){\n        this.$notify.error({ title: '错误',message: '请输入标题'})\n        return\n      }\n      if(this.formData.title.length > 15){\n        this.$notify.error({ title: '错误',message: '标题过长，最大15位'})\n        return\n      }\n      if(this.formData.smallTitle.length && this.formData.smallTitle.length > 20){\n        this.$notify.error({ title: '错误',message: '副标题过长，最大20位'})\n        return\n      }\n      if(!this.formData.coverList.length){\n        this.$notify.error({ title: '错误',message: '请选择封面'})\n        return\n      }\n      if(!this.formData.contentCategory.length){\n        this.$notify.error({ title: '错误',message: '请选择分类'})\n        return\n      }\n      if(!this.formData.tagList.length){\n        this.$notify.error({ title: '错误',message: '请添加标签'})\n        return\n      }\n      switch(this.formData.contentType) {\n        // 发布文章\n        case '4':\n          let html = this.$refs.myArticle.$refs.editor.getEditorHtml()\n          if(html == '<p><br></p>'){\n            this.$notify.error({ title: '错误',message: '请输入文章内容'})\n            return;\n          }\n          this.formData.article.content = html\n          break;\n        // 发布图集\n        case '3':\n          // 加 sort 后端排序\n          if(this.formData.atlasList && this.formData.atlasList.length){\n            this.formData.atlasList.forEach((item, index) => {\n              item.sort = ++index\n            })\n          }else {\n            this.$notify.error({ title: '错误',message: '请选择图片'})\n            return;\n          }\n          break;\n        // 获取视频信息\n        case '2':\n          let infoVideo = this.formData.videoInfoParams.info\n          if(!infoVideo.mediaUrl){\n            this.$notify.error({ title: '错误',message: '请选择视频'})\n            return;\n          }\n          this.formData.mediaUrl = infoVideo.mediaUrl\n          if(infoVideo.fileId){\n            this.formData.fileId = infoVideo.fileId\n            this.formData.libraryId = ''\n            // 如果本地后端存一次\n            this.request(this.api.contentCore.video_save, [infoVideo]).then(data => {\n\n            }).catch(err => {\n            });\n          }else {\n            this.formData.libraryId = infoVideo.libraryId\n          }\n          break;\n        case '1':\n          let info = this.formData.videoInfoParams.info\n          if(!info.mediaUrl){\n            this.$notify.error({ title: '错误',message: '请选择视频'})\n            return;\n          }\n          this.formData.mediaUrl = info.mediaUrl\n          if(info.fileId){\n            this.formData.fileId = info.fileId\n            this.formData.libraryId = ''\n            // 如果本地后端存一次\n            this.request(this.api.contentCore.video_save, [info]).then(data => {\n\n            }).catch(err => {\n\n            });\n          }else {\n            this.formData.libraryId = info.libraryId\n          }\n          break;\n      }\n      // 公共的处理参数\n      // 是否存草稿\n      if(!state){\n        this.formData.contentStatus = '0'\n      }else{\n        this.formData.contentStatus = 1\n      }\n      // 分类转格式\n      const categoryAry = this.formData.contentCategory[this.formData.contentCategory.length-1].split('&')\n      this.formData.contentCategoryId = categoryAry[0]\n      this.formData.cIdentifier = categoryAry[1]\n      this.formData.showIdentifier = this.formData.contentCategory.join('$')\n      // 地域格式转换\n      this.formData.region = this.formData.regions.join('$')\n      // 关联商品转换\n      if(this.formData.relationInfoList && this.formData.relationInfoList.length){\n        this.formData.relationInfo = JSON.stringify(this.formData.relationInfoList)\n      }\n      // 请求\n      let url = this.api.contentCore.content_save\n      if(this.formData.id){\n        url = this.api.contentCore.content_edit\n      }\n      this.request(url, this.formData).then(data => {\n        if(this.editId){\n          this.$notify.success({ title: '成功',message: '修改成功'})\n        }else{\n          if(this.timeDialog){\n            this.$notify.success({ title: '成功',message: '发布成功'})\n            this.timeDialog = false\n          }else if(this.formData.contentStatus === '0'){\n            this.$notify.success({ title: '成功',message: '草稿保存成功'})\n          }else{\n            this.$notify.success({ title: '成功',message: '发布成功'})\n          }\n        }\n        this.init()\n        this.$router.push({\n          path:'/content/manage/content_manage'\n        });\n      });\n    },\n    // 获取详情\n    getDetails(){\n      this.request(this.api.contentCore.content_get, {id: this.editId}).then(data => {\n        let activeItem = this.tabs.find(item => {\n          return data.contentType == item.type\n        })\n        this.activeName = activeItem.name\n        let contentCategory,regions,relationInfoList\n        // 初始分类\n        if(data.showIdentifier.indexOf('$') > -1){\n          contentCategory = data.showIdentifier.split('$')\n        }else {\n          contentCategory = [data.showIdentifier]\n        }\n        // 初始区域\n        if(data.region.indexOf('$') > -1){\n          regions = data.region.split('$')\n        }else if(regions){\n          regions = [data.region]\n        }else {\n          regions = []\n        }\n        // 初始关联列表\n        if(data.relationInfo.length){\n          relationInfoList = JSON.parse(data.relationInfo)\n        }else {\n          relationInfoList = []\n        }\n        this.formData = {\n          id: this.editId,\n          contentType: data.contentType.toString(),     // 4 文章发布  3 图集发布   2 小视频发布  1 视频发布\n          // 标题\n          title: data.title,\n          //副标题\n          smallTitle: data.smallTitle,\n          // 封面\n          coverList: data.coverList,\n          // 分类\n          contentCategory: contentCategory,\n          // 标签\n          tagList: data.tagList,\n          // 地域\n          region: '',\n          regions: regions,\n          relationInfoList:relationInfoList,\n          relationInfo: '',\n          // 是否草稿\n          contentStatus: '',\n          // 是否定时\n          isTime: 0,\n          // 定时时间\n          pubDate: '',\n          // 文章\n          // 富文本信息\n          article: {\n            content: ''\n          },\n          // 图集\n          atlasList: [],\n          // 视频\n          // 是否素材\n          libraryId: data.libraryId,\n          videoInfoParams: {},\n          mediaUrl: '',\n          fileId: ''\n        }\n        // 标签表结构修改 新加字段判断 新字段 tagList(Array)    旧字段  tags(String)\n        /*if(data.tagList && data.tagList.length){\n          this.formData.tagList = data.tagList\n        }else{\n          if(data.tags){\n            if(data.tags.indexOf('$') > -1){\n              this.formData.tagList = data.tags.split('$').map(item => {\n                return {\n                  name: item\n                }\n              })\n            }else{\n              this.formData.tagList = [{\n                name: data.tags\n              }]\n            }\n          }else {\n            this.formData.tagList = []\n          }\n        }*/\n        switch(data.contentType) {\n          // 发布文章\n          case 4:\n            let html = data.articleDomain.content\n            setTimeout(()=>{\n              this.$refs.myArticle.$refs.editor.setEditorHtml(html)\n            },0)\n            this.formData.article.sourceId = data.articleDomain.sourceId\n            this.formData.article.id = data.articleDomain.id\n            break;\n          // 发布图集\n          case 3:\n            this.formData.atlasList = data.atlasList\n            break;\n          // 获取视频信息\n          case 2:\n            this.formData.videoInfoParams.info = {\n              mediaUrl: data.mediaUrl,\n              libraryId: data.libraryId\n            }\n            break;\n          case 1:\n            this.formData.videoInfoParams.info = {\n              mediaUrl: data.mediaUrl,\n              libraryId: data.libraryId\n            }\n            break;\n        }\n      })\n    }\n  },\n  // 计算属性\n  computed: {},\n  // 监听数据变化\n  watch: {\n    '$route':{\n      handler: function (val, oldVal) {\n        if(val.path === oldVal.path){\n          this.init()\n          this.editId = null\n          this.activeName = 'myArticle'\n          this.formData.contentType = '4'\n        }\n      },\n      deep: true\n    }\n  }\n}\n",{"version":3,"sources":["release.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"release.vue","sourceRoot":"src/views/content/create","sourcesContent":["<style lang=\"less\" scoped>\r\n  @import \"../style/contentPublic.less\";\r\n  .release{\r\n    .tabs{background: #fff;\r\n      width: 100%;\r\n    }\r\n    .footer-btns{background: #fff;padding: 10px 20px;\r\n      div{float: right;}\r\n    }\r\n  }\r\n</style>\r\n<template>\r\n  <div class=\"release page-public\">\r\n    <div class=\"page-main item-margin\">\r\n      <div class=\"page-main-inner\">\r\n        <el-tabs v-model=\"activeName\" class=\"tabs\" :before-leave=\"handleBeforeClick\" type=\"card\">\r\n          <el-tab-pane label=\"发布文章\" name=\"myArticle\" contentType=\"4\">\r\n            <my-article :form-data=\"formData\" ref=\"myArticle\" v-if=\"activeName == 'myArticle'\"></my-article>\r\n          </el-tab-pane>\r\n          <el-tab-pane label=\"发布图集\" name=\"myAtlas\" contentType=\"3\">\r\n            <my-atlas :form-data=\"formData\" ref=\"myAtlas\" v-if=\"activeName == 'myAtlas'\"></my-atlas>\r\n          </el-tab-pane>\r\n          <el-tab-pane label=\"发布小视频\" name=\"videoSmall\" contentType=\"2\">\r\n            <my-video  :form-data=\"formData\" ref=\"videoSmall\"  v-if=\"activeName == 'videoSmall'\"></my-video>\r\n<!--            <my-small-video :formData=\"formData\" ref=\"videoSmall\" v-if=\"activeName == 'videoSmall'\"></my-small-video>-->\r\n          </el-tab-pane>\r\n          <el-tab-pane label=\"发布视频\" name=\"video\" contentType=\"1\" ref=\"video\">\r\n            <my-video  :form-data=\"formData\" ref=\"video\"  v-if=\"activeName == 'video'\"></my-video>\r\n          </el-tab-pane>\r\n        </el-tabs>\r\n      </div>\r\n    </div>\r\n    <div class=\"footer-btns clearfix item-margin\">\r\n      <div>\r\n        <el-button type=\"primary\" size=\"small\" @click=\"contentSave(true)\">发布</el-button>\r\n        <el-button size=\"small\" @click=\"contentSave(false)\">存草稿</el-button>\r\n        <el-button size=\"small\" @click=\"timeDialog = true\">定时发布</el-button>\r\n        <el-button size=\"small\">预览</el-button>\r\n      </div>\r\n    </div>\r\n    <!--定时弹窗-->\r\n    <el-dialog title=\"添加定时\" :visible.sync=\"timeDialog\" width=\"40%\" :close-on-click-modal=\"false\">\r\n      <el-form :model=\"formData\" :rules=\"rules\" ref=\"pubDateForm\" label-width=\"130px\" class=\"demo-ruleForm\">\r\n        <el-form-item label=\"选择发布时间\" prop=\"pubDate\">\r\n          <el-date-picker v-model=\"formData.pubDate\" type=\"datetime\" placeholder=\"选择日期时间\" size=\"small\"></el-date-picker>\r\n        </el-form-item>\r\n      </el-form>\r\n      <p v-show=\"formData.pubDate\">本内容将于{{ formData.pubDate | timestampToTime }} 发表</p>\r\n      <span slot=\"footer\" class=\"dialog-footer\">\r\n        <el-button @click=\"timeDialog = false\" size=\"small\">取 消</el-button>\r\n        <el-button @click=\"timeDialogSub\" type=\"primary\" size=\"small\">确定并发布</el-button>\r\n      </span>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n<script>\r\n  import Article from '@/views/content/create/components/Article'\r\n  import Atlas from '@/views/content/create/components/Atlas'\r\n  import Video from '@/views/content/create/components/Video'\r\n  export default {\r\n    name: 'release',\r\n    // 组件\r\n    components: {\r\n      'my-article': Article,\r\n      'my-atlas': Atlas,\r\n      'my-video': Video\r\n    },\r\n    // 数据\r\n    data() {\r\n      return {\r\n        tabs: [\r\n          {type: '4', name: 'myArticle'},\r\n          {type: '3', name: 'myAtlas'},\r\n          {type: '2', name: 'videoSmall'},\r\n          {type: '1', name: 'video'}\r\n        ],\r\n        // 提交表单\r\n        formData: {\r\n          // 类型\r\n          contentType: '',     // 4 文章发布  3 图集发布   2 小视频发布  1 视频发布\r\n          // 标题\r\n          title: '',\r\n          //副标题\r\n          smallTitle: '',\r\n          // 封面\r\n          coverList: [],\r\n          // 分类\r\n          contentCategory:[],\r\n          // 标签\r\n          tagList: [],\r\n          // 地狱\r\n          region: '',\r\n          regions: [],\r\n          // 商品链接\r\n          relationInfoList:[],\r\n          relationInfo: '',\r\n          // 是否草稿\r\n          contentStatus: '',\r\n          // 是否定时\r\n          isTime: 0,\r\n          // 定时时间\r\n          pubDate: '',\r\n\r\n          // 文章\r\n          // 富文本信息\r\n          article: {\r\n            content:''\r\n          },\r\n\r\n          // 图集\r\n          atlasList: [],\r\n\r\n          // 视频\r\n          // 是否素材\r\n          libraryId: '',\r\n          videoInfoParams:{\r\n            info: null\r\n          },\r\n          mediaUrl: '',\r\n          fileId: ''\r\n        },\r\n        timeDialog: false,\r\n        rules: {\r\n          pubDate: [\r\n            {required: true, message: '请选择发布时间', trigger: 'blur'}\r\n          ]\r\n        },\r\n\r\n        // 默认显示的tabs\r\n        activeName: '',\r\n        editId: null\r\n      }\r\n    },\r\n    created(){\r\n      this.editId =  this.$route.query.id\r\n      if(this.editId){\r\n        this.getDetails()\r\n      }else{\r\n        this.activeName = 'myArticle'\r\n        this.formData.contentType = '4'\r\n      }\r\n    },\r\n    // 初始化数据\r\n    mounted() {\r\n      this.$nextTick(() => {\r\n\r\n      })\r\n    },\r\n    // keepAlive 页面显示时\r\n    activated() {\r\n      this.getTableList();\r\n    },\r\n    // 方法\r\n    methods: {\r\n      init(){\r\n        this.formDataInit()\r\n       /* this.$nextTick(()=>{\r\n\r\n        })*/\r\n       setTimeout(()=>{\r\n         if(this.$refs[this.activeName]){\r\n           this.$refs[this.activeName].init()\r\n         }\r\n       },0)\r\n      },\r\n      formDataInit(){\r\n        // 初始化数据\r\n        this.formData = {\r\n          // 类型\r\n          contentType: this.formData.contentType,     // 4 文章发布  3 图集发布   2 小视频发布  1 视频发布\r\n          // 标题\r\n          title: '',\r\n          //副标题\r\n          smallTitle: '',\r\n          // 封面\r\n          coverList: [],\r\n          // 分类\r\n          contentCategory:[],\r\n          // 标签\r\n          tagList: [],\r\n          // 地狱\r\n          region: '',\r\n          regions: [],\r\n          // 商品链接\r\n          relationInfoList:[],\r\n          relationInfo: '',\r\n          // 是否草稿\r\n          contentStatus: '',\r\n          // 是否定时\r\n          isTime: 0,\r\n          // 定时时间\r\n          pubDate: '',\r\n          // 文章\r\n          // 富文本信息\r\n          article: {\r\n            content:''\r\n          },\r\n          // 图集\r\n          atlasList: [],\r\n          // 视频\r\n          // 是否素材\r\n          libraryId: '',\r\n          videoInfoParams:{\r\n            info: null\r\n          },\r\n          mediaUrl: '',\r\n          fileId: ''\r\n        }\r\n      },\r\n      async handleBeforeClick(activeName, oldActiveName){\r\n        if(!oldActiveName || oldActiveName == '0'){\r\n          return true\r\n        }else{\r\n          let activeItem = this.tabs.find(item => {\r\n            return activeName == item.name\r\n          })\r\n          if(this.editId){\r\n            const flag = await this.$confirm('点击确认视为放弃本次编辑，开始其他类型的发布', '切换', {\r\n              confirmButtonText: '确认',\r\n              cancelButtonText: '取消',\r\n              showClose:false\r\n            });\r\n            if(flag){\r\n              this.formData.id = null\r\n              this.editId = null\r\n              this.formData.contentType = activeItem.type\r\n              this.$route.query.id = null\r\n              this.init()\r\n              return true\r\n            }else{\r\n              return false\r\n            }\r\n          }else{\r\n            this.formData.contentType = activeItem.type\r\n            this.init()\r\n            return true\r\n          }\r\n        }\r\n      },\r\n      // 确认定时\r\n      timeDialogSub(){\r\n        this.$refs.pubDateForm.validate((valid) => {\r\n          if (valid) {\r\n            this.formData.isTime = 1\r\n            this.contentSave(true);\r\n          } else {\r\n            return false;\r\n          }\r\n        });\r\n      },\r\n      // 发布\r\n      contentSave(state){\r\n        if(!this.formData.title){\r\n          this.$notify.error({ title: '错误',message: '请输入标题'})\r\n          return\r\n        }\r\n        if(this.formData.title.length > 15){\r\n          this.$notify.error({ title: '错误',message: '标题过长，最大15位'})\r\n          return\r\n        }\r\n        if(this.formData.smallTitle.length && this.formData.smallTitle.length > 20){\r\n          this.$notify.error({ title: '错误',message: '副标题过长，最大20位'})\r\n          return\r\n        }\r\n        if(!this.formData.coverList.length){\r\n          this.$notify.error({ title: '错误',message: '请选择封面'})\r\n          return\r\n        }\r\n        if(!this.formData.contentCategory.length){\r\n          this.$notify.error({ title: '错误',message: '请选择分类'})\r\n          return\r\n        }\r\n        if(!this.formData.tagList.length){\r\n          this.$notify.error({ title: '错误',message: '请添加标签'})\r\n          return\r\n        }\r\n        switch(this.formData.contentType) {\r\n          // 发布文章\r\n          case '4':\r\n            let html = this.$refs.myArticle.$refs.editor.getEditorHtml()\r\n            if(html == '<p><br></p>'){\r\n              this.$notify.error({ title: '错误',message: '请输入文章内容'})\r\n              return;\r\n            }\r\n            this.formData.article.content = html\r\n            break;\r\n          // 发布图集\r\n          case '3':\r\n            // 加 sort 后端排序\r\n            if(this.formData.atlasList && this.formData.atlasList.length){\r\n              this.formData.atlasList.forEach((item, index) => {\r\n                item.sort = ++index\r\n              })\r\n            }else {\r\n              this.$notify.error({ title: '错误',message: '请选择图片'})\r\n              return;\r\n            }\r\n            break;\r\n          // 获取视频信息\r\n          case '2':\r\n            let infoVideo = this.formData.videoInfoParams.info\r\n            if(!infoVideo.mediaUrl){\r\n              this.$notify.error({ title: '错误',message: '请选择视频'})\r\n              return;\r\n            }\r\n            this.formData.mediaUrl = infoVideo.mediaUrl\r\n            if(infoVideo.fileId){\r\n              this.formData.fileId = infoVideo.fileId\r\n              this.formData.libraryId = ''\r\n              // 如果本地后端存一次\r\n              this.request(this.api.contentCore.video_save, [infoVideo]).then(data => {\r\n\r\n              }).catch(err => {\r\n              });\r\n            }else {\r\n              this.formData.libraryId = infoVideo.libraryId\r\n            }\r\n            break;\r\n          case '1':\r\n            let info = this.formData.videoInfoParams.info\r\n            if(!info.mediaUrl){\r\n              this.$notify.error({ title: '错误',message: '请选择视频'})\r\n              return;\r\n            }\r\n            this.formData.mediaUrl = info.mediaUrl\r\n            if(info.fileId){\r\n              this.formData.fileId = info.fileId\r\n              this.formData.libraryId = ''\r\n              // 如果本地后端存一次\r\n              this.request(this.api.contentCore.video_save, [info]).then(data => {\r\n\r\n              }).catch(err => {\r\n\r\n              });\r\n            }else {\r\n              this.formData.libraryId = info.libraryId\r\n            }\r\n            break;\r\n        }\r\n        // 公共的处理参数\r\n        // 是否存草稿\r\n        if(!state){\r\n          this.formData.contentStatus = '0'\r\n        }else{\r\n          this.formData.contentStatus = 1\r\n        }\r\n        // 分类转格式\r\n        const categoryAry = this.formData.contentCategory[this.formData.contentCategory.length-1].split('&')\r\n        this.formData.contentCategoryId = categoryAry[0]\r\n        this.formData.cIdentifier = categoryAry[1]\r\n        this.formData.showIdentifier = this.formData.contentCategory.join('$')\r\n        // 地域格式转换\r\n        this.formData.region = this.formData.regions.join('$')\r\n        // 关联商品转换\r\n        if(this.formData.relationInfoList && this.formData.relationInfoList.length){\r\n          this.formData.relationInfo = JSON.stringify(this.formData.relationInfoList)\r\n        }\r\n        // 请求\r\n        let url = this.api.contentCore.content_save\r\n        if(this.formData.id){\r\n          url = this.api.contentCore.content_edit\r\n        }\r\n        this.request(url, this.formData).then(data => {\r\n          if(this.editId){\r\n            this.$notify.success({ title: '成功',message: '修改成功'})\r\n          }else{\r\n            if(this.timeDialog){\r\n              this.$notify.success({ title: '成功',message: '发布成功'})\r\n              this.timeDialog = false\r\n            }else if(this.formData.contentStatus === '0'){\r\n              this.$notify.success({ title: '成功',message: '草稿保存成功'})\r\n            }else{\r\n              this.$notify.success({ title: '成功',message: '发布成功'})\r\n            }\r\n          }\r\n          this.init()\r\n          this.$router.push({\r\n            path:'/content/manage/content_manage'\r\n          });\r\n        });\r\n      },\r\n      // 获取详情\r\n      getDetails(){\r\n        this.request(this.api.contentCore.content_get, {id: this.editId}).then(data => {\r\n          let activeItem = this.tabs.find(item => {\r\n            return data.contentType == item.type\r\n          })\r\n          this.activeName = activeItem.name\r\n          let contentCategory,regions,relationInfoList\r\n          // 初始分类\r\n          if(data.showIdentifier.indexOf('$') > -1){\r\n            contentCategory = data.showIdentifier.split('$')\r\n          }else {\r\n            contentCategory = [data.showIdentifier]\r\n          }\r\n          // 初始区域\r\n          if(data.region.indexOf('$') > -1){\r\n            regions = data.region.split('$')\r\n          }else if(regions){\r\n            regions = [data.region]\r\n          }else {\r\n            regions = []\r\n          }\r\n          // 初始关联列表\r\n          if(data.relationInfo.length){\r\n            relationInfoList = JSON.parse(data.relationInfo)\r\n          }else {\r\n            relationInfoList = []\r\n          }\r\n          this.formData = {\r\n            id: this.editId,\r\n            contentType: data.contentType.toString(),     // 4 文章发布  3 图集发布   2 小视频发布  1 视频发布\r\n            // 标题\r\n            title: data.title,\r\n            //副标题\r\n            smallTitle: data.smallTitle,\r\n            // 封面\r\n            coverList: data.coverList,\r\n            // 分类\r\n            contentCategory: contentCategory,\r\n            // 标签\r\n            tagList: data.tagList,\r\n            // 地域\r\n            region: '',\r\n            regions: regions,\r\n            relationInfoList:relationInfoList,\r\n            relationInfo: '',\r\n            // 是否草稿\r\n            contentStatus: '',\r\n            // 是否定时\r\n            isTime: 0,\r\n            // 定时时间\r\n            pubDate: '',\r\n            // 文章\r\n            // 富文本信息\r\n            article: {\r\n              content: ''\r\n            },\r\n            // 图集\r\n            atlasList: [],\r\n            // 视频\r\n            // 是否素材\r\n            libraryId: data.libraryId,\r\n            videoInfoParams: {},\r\n            mediaUrl: '',\r\n            fileId: ''\r\n          }\r\n          // 标签表结构修改 新加字段判断 新字段 tagList(Array)    旧字段  tags(String)\r\n          /*if(data.tagList && data.tagList.length){\r\n            this.formData.tagList = data.tagList\r\n          }else{\r\n            if(data.tags){\r\n              if(data.tags.indexOf('$') > -1){\r\n                this.formData.tagList = data.tags.split('$').map(item => {\r\n                  return {\r\n                    name: item\r\n                  }\r\n                })\r\n              }else{\r\n                this.formData.tagList = [{\r\n                  name: data.tags\r\n                }]\r\n              }\r\n            }else {\r\n              this.formData.tagList = []\r\n            }\r\n          }*/\r\n          switch(data.contentType) {\r\n            // 发布文章\r\n            case 4:\r\n              let html = data.articleDomain.content\r\n              setTimeout(()=>{\r\n                this.$refs.myArticle.$refs.editor.setEditorHtml(html)\r\n              },0)\r\n              this.formData.article.sourceId = data.articleDomain.sourceId\r\n              this.formData.article.id = data.articleDomain.id\r\n              break;\r\n            // 发布图集\r\n            case 3:\r\n              this.formData.atlasList = data.atlasList\r\n              break;\r\n            // 获取视频信息\r\n            case 2:\r\n              this.formData.videoInfoParams.info = {\r\n                mediaUrl: data.mediaUrl,\r\n                libraryId: data.libraryId\r\n              }\r\n              break;\r\n            case 1:\r\n              this.formData.videoInfoParams.info = {\r\n                mediaUrl: data.mediaUrl,\r\n                libraryId: data.libraryId\r\n              }\r\n              break;\r\n          }\r\n        })\r\n      }\r\n    },\r\n    // 计算属性\r\n    computed: {},\r\n    // 监听数据变化\r\n    watch: {\r\n      '$route':{\r\n        handler: function (val, oldVal) {\r\n          if(val.path === oldVal.path){\r\n            this.init()\r\n            this.editId = null\r\n            this.activeName = 'myArticle'\r\n            this.formData.contentType = '4'\r\n          }\r\n        },\r\n        deep: true\r\n      }\r\n    }\r\n  }\r\n</script>\r\n"]}]}