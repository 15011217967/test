{"remainingRequest":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\src\\views\\product\\format\\single_details.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\src\\views\\product\\format\\single_details.vue","mtime":1572415124078},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1558492728398},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\babel-loader\\lib\\index.js","mtime":1558492720858},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1558492728398},{"path":"C:\\Users\\EDZ\\Desktop\\研发项目\\vue-project\\trunk\\node_modules\\vue-loader\\lib\\index.js","mtime":1558492728890}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\nimport SingleMaterialDialog from \"@/components/customAttribute/single_material_dialog\";\r\nimport SingleTechnologyDialog from \"@/components/customAttribute/single_technology_dialog\";\r\nimport NewSku from \"@/components/SKUAssembly/add_new_sku\";\r\n/**\r\n * TODO  一些地方用不掉... 深复制\r\n * 如优化 需去掉\r\n */\r\n/**\r\n * 父组件已选原料镜像\r\n */\r\nlet middlewareMaterialList = [];\r\n/**\r\n * 父组件已选工艺镜像\r\n */\r\nlet middlewareTechnologyList = [];\r\n/**\r\n * 原料和工艺数据合并生成的新数据\r\n */\r\nlet materialAndTechnologyList = [];\r\nlet cusCateType=false,cusTableType=false;\r\nexport default {\r\n  data() {\r\n    return {\r\n      filtersData: {},\r\n      activeName: \"material\", //切换\r\n      rules: {\r\n        //规则验证\r\n        valid: [{ required: true, message: \"请选择状态\", trigger: \"change\" }],\r\n        name: [{ required: true, message: \"请输入商品名称\", trigger: \"blur\" },\r\n        {max:24, message: \"最长24个汉字\", trigger: \"blur\" }]\r\n      },\r\n\r\n      editDisabled: false,\r\n      showDisabled: false,\r\n      materialTableListData: [], //原料table列表\r\n      technologyTableListData: [], //工艺 table 列表\r\n      fullCateName: \"\", //分类显示\r\n      //定制分类搜索\r\n      classData: [],\r\n      classList: [],\r\n      //属性分类数据\r\n      attrClassData: [],\r\n      attrListData: [],\r\n      //定制分类\r\n      cateArr: [],\r\n      //属性分类\r\n      materialAttrCateArr: [],\r\n      //工艺分类\r\n      technologyAttrCateArr: [],\r\n      props: {\r\n        value: \"id\",\r\n        label: \"name\",\r\n        children: \"children\"\r\n      },\r\n      //原料搜索字段\r\n      materialForm: {\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      },\r\n      //工艺搜索字段\r\n      technologyForm: {\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      },\r\n      _type: \"\",\r\n      _id: \"\",\r\n      //定制货品信息列表\r\n      productGoodses: [],\r\n      cusPlaceholder: \"请选择定制分类\",\r\n      setCateIdentifier:\"\",//后台获取的定制分类\r\n    };\r\n  },\r\n  created() {\r\n    this.init();\r\n    this.getClassData();\r\n    this.getQueryparams();\r\n  },\r\n  methods: {\r\n    init(){\r\n      middlewareMaterialList = [];\r\n      middlewareTechnologyList = [];\r\n      materialAndTechnologyList = [];\r\n      this.filtersData={};\r\n      this.materialTableListData=[]; //原料table列表\r\n      this.technologyTableListData=[];\r\n      this.productGoodses=[];\r\n      this.materialForm={\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      };\r\n      //工艺搜索字段\r\n      this.technologyForm={\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      };\r\n      cusCateType=false;cusTableType=false;\r\n    },\r\n    getClassData() {\r\n      //分类类型（1：标准分类，2：定制分类，3：原料分类或者称为属性分类）\r\n      this.$common.getClassSelect(this, 2).then(res => {\r\n        this.classData = res.ztree;\r\n        this.classList = res.list;\r\n        cusCateType=true;\r\n        this.setCusCateName();\r\n      });\r\n      //获取属性分类  type 3\r\n      this.$common.getClassSelect(this, 3).then(res => {\r\n        this.attrClassData = res.ztree;\r\n        this.attrListData = res.list;\r\n\r\n      });\r\n    },\r\n    //定制分类\r\n    cascaderGet(e) {\r\n      let cateId = JSON.parse(JSON.stringify(e)).pop();\r\n      let obj = this.classList.find(item => item.id == cateId);\r\n      this.filtersData.cusCateIdentifier = obj.identifier;\r\n      this.filtersData.cusCateId = obj.id;\r\n      this.filtersData.cusCateName = obj.name;\r\n      this.filtersData.cusFullCateName = obj.fullCateName;\r\n    },\r\n    //原料属性分类\r\n    materialAttrCascaderGet(e) {\r\n      let cateId = JSON.parse(JSON.stringify(e)).pop();\r\n      let obj = this.attrListData.find(item => item.id == cateId);\r\n      this.materialForm.materialCateId = obj.id;\r\n      // this.materialForm.materialCateIdentifier = obj.identifier;\r\n    },\r\n    //工艺属性分类\r\n    technologyAttrCascaderGet(e) {\r\n      let cateId = JSON.parse(JSON.stringify(e)).pop();\r\n      let obj = this.attrListData.find(item => item.id == cateId);\r\n      this.technologyForm.materialCateId = obj.id;\r\n    },\r\n    //获取上页面参数\r\n    getQueryparams() {\r\n      let params = this.$route.query;\r\n      this._type = params._type;\r\n      this._id = params._id;\r\n      let itemStatus = this._type;\r\n      switch (itemStatus.toString()) {\r\n        case \"add\": //新增\r\n          this.editDisabled = false;\r\n          this.showDisabled = false;\r\n          this.fullCateName = params.fullCateName;\r\n          let filters = this.filtersData;\r\n          ({\r\n            cateId: filters.cateId,\r\n            cateName: filters.cateName,\r\n            cateIdentifier: filters.cateIdentifier,\r\n            fullCateName: filters.fullCateName\r\n          } = params);\r\n          break;\r\n        case \"edit\": //修改\r\n          this.editDisabled = true;\r\n          this.showDisabled = false;\r\n          this.getData();\r\n          break;\r\n        case \"show\": //查看\r\n          this.editDisabled = true;\r\n          this.showDisabled = true;\r\n          this.getData();\r\n          break;\r\n      }\r\n    },\r\n    //添加sku\r\n    addSkuBtn() {\r\n      if (middlewareMaterialList.length <= 0) {\r\n        this.$message.error(\"请选择原料\");\r\n        return false;\r\n      }\r\n      if (middlewareTechnologyList.length <= 0) {\r\n        this.$message.error(\"请选择工艺\");\r\n        return false;\r\n      }\r\n      let List = this.arrCopy(materialAndTechnologyList);\r\n      this.$refs.skuRef.popupInit(\"add\", List);\r\n    },\r\n    //获取SKU子组件返回的数据\r\n    getSubSKUData(skuData) {\r\n      this.productGoodses.push(skuData);\r\n      if (this.productGoodses.length == 1) {\r\n        this.productGoodses[0].defaultStatus = true;\r\n      }\r\n    },\r\n    //获取SKU子组件编辑后返回的数据\r\n    getSubEditSKUData(editSkuData, subType, subIndex) {\r\n      if (subType == \"edit\") {\r\n        this.productGoodses.splice(subIndex, 1, editSkuData);\r\n      }\r\n    },\r\n    //编辑当前的sku\r\n    skuEditItem(item, _index) {\r\n      if (middlewareMaterialList.length <= 0) {\r\n        this.$message.error(\"请选择原料\");\r\n        return false;\r\n      }\r\n      if (middlewareTechnologyList.length <= 0) {\r\n        this.$message.error(\"请选择工艺\");\r\n        return false;\r\n      }\r\n      let List = this.arrCopy(materialAndTechnologyList);\r\n      let skuItem = JSON.parse(JSON.stringify(item)),\r\n        skuIndex = _index;\r\n      this.$refs.skuRef.editPopupInit(\r\n        \"edit\",\r\n        List,\r\n        skuItem,\r\n        skuIndex,\r\n        this._type\r\n      );\r\n    },\r\n    //删除当前的SKU\r\n    skuIconRemove(item, _index) {\r\n      this.productGoodses.splice(_index, 1);\r\n    },\r\n    //添加原料\r\n    openAddMaterial() {\r\n      this.$refs.materialDialogRef.popupInit(\r\n        this.filtersData.cateIdentifier,\r\n        this._type,\r\n        this.arrCopy(middlewareMaterialList),\r\n        this.arrCopy(this.productGoodses)\r\n      );\r\n    },\r\n    //子组件传回的已选数据\r\n    getSubMaterialList(list, productGoodsesIds) {\r\n      console.log(list);\r\n      let subMaterialList = list;\r\n      //假如是新增的情况下 根本不需要做很多判断 直接放入\r\n      this.materialTableListData = subMaterialList;\r\n      middlewareMaterialList = [...subMaterialList];\r\n      materialAndTechnologyList = [\r\n        ...middlewareMaterialList,\r\n        ...middlewareTechnologyList\r\n      ];\r\n      this.SPUReset(\"material\", this.materialForm);\r\n      this.SPUSearch(\"material\", this.materialForm);\r\n      //删除已选SKU\r\n      this.arrRemoveSelectedSku(productGoodsesIds);\r\n    },\r\n    //添加工艺\r\n    openAddTechnology() {\r\n      //当点添加的时候 存个当前的数据\r\n      this.$refs.technologyDialogRef.popupInit(\r\n        this.filtersData.cateIdentifier,\r\n        this._type,\r\n        this.arrCopy(middlewareTechnologyList),\r\n        this.arrCopy(this.productGoodses)\r\n      );\r\n    },\r\n    //工艺添加成功后返回的数据\r\n    getSubTechnologyList(list, productGoodsesIds) {\r\n      let subMaterialList = list;\r\n      //假如是新增的情况下 根本不需要做很多判断 直接放入\r\n      this.technologyTableListData = subMaterialList;\r\n      middlewareTechnologyList = [...subMaterialList];\r\n      materialAndTechnologyList = [\r\n        ...middlewareMaterialList,\r\n        ...middlewareTechnologyList\r\n      ];\r\n      this.SPUReset(\"technology\", this.technologyForm);\r\n      this.SPUSearch(\"technology\", this.technologyForm);\r\n      //删除已选SKU\r\n      this.arrRemoveSelectedSku(productGoodsesIds);\r\n    },\r\n    //原料搜索及原料重置  TODO //以后和工艺合并\r\n    SPUSearch(SPUType, SPUForm) {\r\n      let filters = SPUForm;\r\n      if (filters.materialCateId == \"\" && filters.searchWords == \"\") {\r\n        if (SPUType == \"material\") {\r\n          this.materialTableListData = [...middlewareMaterialList];\r\n        } else {\r\n          this.technologyTableListData = [...middlewareTechnologyList];\r\n        }\r\n        filters = null;\r\n        return false;\r\n      }\r\n      //镜像数据 搜索时拿到全部的数据 也就是镜像数据;\r\n      let middleTableList =\r\n        SPUType == \"material\"\r\n          ? [...middlewareMaterialList]\r\n          : [...middlewareTechnologyList];\r\n      let filtersList = [];\r\n      if (!!filters.materialCateId) {\r\n        for (let i = 0; i < middleTableList.length; i++) {\r\n          if (\r\n            middleTableList[i].materialCateId.search(filters.materialCateId) !=\r\n            -1\r\n          ) {\r\n            filtersList.push(middleTableList[i]);\r\n           // break;\r\n          }\r\n        }\r\n      } else {\r\n        filtersList =\r\n          SPUType == \"material\"\r\n            ? [...middlewareMaterialList]\r\n            : [...middlewareTechnologyList];\r\n      }\r\n      let List = [];\r\n      if (!!filters.searchWords) {\r\n        for (let i = 0; i < filtersList.length; i++) {\r\n          let str = `${filtersList[i].name}${filtersList[i].code}`;\r\n          if (str.toUpperCase().search(filters.searchWords.toUpperCase()) != -1) {\r\n            List.push(filtersList[i]);\r\n           // break;\r\n          }\r\n        }\r\n      } else {\r\n        List = filtersList;\r\n      }\r\n      if (SPUType == \"material\") {\r\n        this.materialTableListData = List;\r\n      } else {\r\n        this.technologyTableListData = List;\r\n      }\r\n      filtersList = null;\r\n      List = null;\r\n      middleTableList = null;\r\n    },\r\n    SPUReset(SPUType, SPUForm) {\r\n      if (SPUType == \"material\") {\r\n        this.materialForm = {\r\n          materialCateId: \"\",\r\n          searchWords: \"\"\r\n        };\r\n        this.materialAttrCateArr = [];\r\n      } else {\r\n        this.technologyForm = {\r\n          materialCateId: \"\",\r\n          searchWords: \"\"\r\n        };\r\n        this.technologyAttrCateArr = [];\r\n      }\r\n    },\r\n    //新增\r\n    submitForm(formName) {\r\n      this.$refs[formName].validate(valid => {\r\n        if (valid) {\r\n          let filters = this.filtersData;\r\n          filters.productGoodses = [...this.productGoodses];\r\n          filters.productMaterials = [...materialAndTechnologyList];\r\n          console.log(this.filtersData);\r\n          this.request(\r\n            this.api.product.customizedProduct_save,\r\n            this.filtersData\r\n          ).then(data => {\r\n            this.$message.success(\"保存成功\");\r\n            setTimeout(() => {\r\n              this.routerback();\r\n            }, 500);\r\n          });\r\n        } else {\r\n          console.log(\"error submit!!\");\r\n          return false;\r\n        }\r\n      });\r\n    },\r\n    //修改保存\r\n    submitEditForm(formName) {\r\n      console.log(materialAndTechnologyList);\r\n      this.$refs[formName].validate(valid => {\r\n        if (valid) {\r\n          let filters = JSON.parse(JSON.stringify(this.filtersData));\r\n          //处理已选数组\r\n          let mirrorFilters = JSON.parse(JSON.stringify(this.filtersData));\r\n          let mirrorMTMR = mirrorFilters.productMaterials;\r\n          let MTMR = materialAndTechnologyList;\r\n          let deleteMTMR = []; //已删除已有ID的数据\r\n          for (let i = 0; i < mirrorMTMR.length; i++) {\r\n            let flag = false;\r\n            for (let k = 0; k < MTMR.length; k++) {\r\n              if (\r\n                mirrorMTMR[i].materialId == MTMR[k].materialId &&\r\n                MTMR[k].id != null\r\n              ) {\r\n                flag = true;\r\n              }\r\n            }\r\n            if (!flag) {\r\n              //此处是已删除的数据 但不正确 还要知道当前数据是不是删除后又新增的\r\n              mirrorMTMR[i].status = 9;\r\n              deleteMTMR.push(mirrorMTMR[i]);\r\n            }\r\n          }\r\n          //处理SKU  镜像sku数据\r\n          let mirrorPtGs = mirrorFilters.productGoodses;\r\n          //当前sku数据\r\n          let ptGs = [...this.productGoodses];\r\n          let deleteGoodses = [];\r\n          for (let i = 0; i < mirrorPtGs.length; i++) {\r\n            //镜像skuI\r\n            let mirrorPtGsMs = mirrorPtGs[i].productGoodsMaterials;\r\n            let parentFlag = false;\r\n            for (let k = 0; k < ptGs.length; k++) {\r\n              //skuk\r\n              let ptGsMs = ptGs[k].productGoodsMaterials;\r\n              //SKU已选数据判断循环\r\n              if (mirrorPtGs[i].id == ptGs[k].id && ptGs[k].id != null) {\r\n                parentFlag = true;\r\n                let deleteArr = [];\r\n                for (let o = 0; o < mirrorPtGsMs.length; o++) {\r\n                  let flag = false;\r\n                  for (let l = 0; l < ptGsMs.length; l++) {\r\n                    if (\r\n                      mirrorPtGsMs[o].materialId == ptGsMs[l].materialId &&\r\n                      ptGsMs[l].id != null\r\n                    ) {\r\n                      flag = true;\r\n                    }\r\n                  }\r\n                  if (!flag) {\r\n                    //此处是已删除的数据 但不正确 还要知道当前数据是不是删除后又新增的\r\n                    mirrorPtGsMs[o].status = 9;\r\n                    deleteArr.push(mirrorPtGsMs[o]);\r\n                  }\r\n                }\r\n                //当前的数据\r\n                ptGs[k].productGoodsMaterials = [...ptGsMs, ...deleteArr];\r\n              }\r\n              //子集循环完成\r\n            }\r\n            if (!parentFlag) {\r\n              mirrorPtGs[i].status = 9;\r\n              deleteGoodses.push(mirrorPtGs[i]);\r\n            }\r\n          }\r\n          filters.productGoodses = [...ptGs, ...deleteGoodses];\r\n          filters.productMaterials = [\r\n            ...materialAndTechnologyList,\r\n            ...deleteMTMR\r\n          ];\r\n          this.request(this.api.product.customizedProduct_save, filters).then(\r\n            data => {\r\n              this.$message.success(\"保存成功\");\r\n              setTimeout(() => {\r\n                this.routerback();\r\n              }, 500);\r\n            }\r\n          );\r\n        } else {\r\n          console.log(\"error submit!!\");\r\n          return false;\r\n        }\r\n      });\r\n    },\r\n    //删除原料数据\r\n    removeMaterialAndTechnology(itemId, listType) {\r\n      let names = [];\r\n      let productGoodses = this.productGoodses;\r\n      for (let i = 0; i < productGoodses.length; i++) {\r\n        let materials = productGoodses[i].productGoodsMaterials;\r\n        for (let k = 0; k < materials.length; k++) {\r\n          if (materials[k].materialId == itemId) {\r\n            names.push(productGoodses[i].name);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      if (names.length > 0) {\r\n        let strName = names.join(\"/\");\r\n        this.$confirm(`sku${strName}已使用到该项，是否确认删除!`, \"提示\", {\r\n          confirmButtonText: \"确定\",\r\n          cancelButtonText: \"取消\",\r\n          type: \"warning\"\r\n        })\r\n          .then(() => {\r\n            //删除操作的时候还需要判断 productGoodsMaterials 的长度 如果为0\r\n            for (let i = 0; i < productGoodses.length; i++) {\r\n              let materials = productGoodses[i].productGoodsMaterials;\r\n              for (let k = 0; k < materials.length; k++) {\r\n                if (materials[k].materialId == itemId) {\r\n                  materials.splice(k, 1);\r\n                  productGoodses[i].valid = false; //未使用状态\r\n                  break;\r\n                }\r\n              }\r\n            }\r\n            this.removeTableAndSku(itemId, listType);\r\n            this.$message({\r\n              type: \"success\",\r\n              message: \"删除成功!\"\r\n            });\r\n          })\r\n          .catch(() => {\r\n            this.$message({\r\n              type: \"info\",\r\n              message: \"已取消删除\"\r\n            });\r\n          });\r\n      } else {\r\n        //未有用到的原料工艺直接删除\r\n        this.removeTableAndSku(itemId, listType);\r\n      }\r\n    },\r\n    //回显数据\r\n    getData() {\r\n      this.request(this.api.product.customizedProduct_get, {\r\n        id: this._id\r\n      }).then(res => {\r\n        console.log(res);\r\n        let _data = res;\r\n        this.filtersData = JSON.parse(JSON.stringify(_data));\r\n        let Materials = [..._data.productMaterials];\r\n        this.fullCateName = _data.fullCateName;\r\n\r\n        let materialsTable = [],\r\n          technologyTable = [];\r\n        for (let i = 0; i < Materials.length; i++) {\r\n          if (Materials[i].type == 2) {\r\n            materialsTable.push(Materials[i]);\r\n          } else {\r\n            technologyTable.push(Materials[i]);\r\n          }\r\n        }\r\n        //回显列表数据；\r\n        this.materialTableListData = materialsTable;\r\n        middlewareMaterialList = [...materialsTable];\r\n        this.technologyTableListData = technologyTable;\r\n        middlewareTechnologyList = [...technologyTable];\r\n        materialAndTechnologyList = [\r\n          ...middlewareMaterialList,\r\n          ...middlewareTechnologyList\r\n        ];\r\n        this.productGoodses = [..._data.productGoodses];\r\n        this.setCateIdentifier = _data.cusCateIdentifier\r\n         if(!!_data.cusCateIdentifier){\r\n          cusTableType=true;\r\n          this.setCusCateName();\r\n        }\r\n\r\n      });\r\n    },\r\n    setCusCateName(){\r\n      if(cusCateType && cusTableType){\r\n        let arr=[];\r\n        let ids=this.setCateIdentifier.split('.');\r\n        let list=this.classList,listLen=list.length;\r\n        for (let k = 0; k < ids.length; k++) {\r\n          for (let i = 0; i < listLen; i++) {\r\n            if(ids[k] == list[i].code){\r\n              arr.push(list[i].id)\r\n              break;\r\n            }\r\n          }\r\n        }\r\n        this.cateArr=arr;\r\n      }\r\n    },\r\n    //删除操作列表和sku\r\n    removeTableAndSku(itemId, listType) {\r\n      if (listType == \"material\") {\r\n        let mlIndex = middlewareMaterialList.findIndex(\r\n          item => item.materialId == itemId\r\n        );\r\n        middlewareMaterialList.splice(mlIndex, 1);\r\n        this.materialTableListData.splice(mlIndex, 1);\r\n      } else {\r\n        let mrIndex = middlewareTechnologyList.findIndex(\r\n          item => item.materialId == itemId\r\n        );\r\n        middlewareTechnologyList.splice(mrIndex, 1);\r\n        this.technologyTableListData.splice(mrIndex, 1);\r\n      }\r\n      let mlmrIndex = materialAndTechnologyList.findIndex(\r\n        item => item.materialId == itemId\r\n      );\r\n      materialAndTechnologyList.splice(mlmrIndex, 1);\r\n    },\r\n    //数组删除SKU已选数据\r\n    arrRemoveSelectedSku(productGoodsesIds) {\r\n      let ids = new Set(productGoodsesIds);\r\n      if (ids.length > 0) {\r\n        let productGoodses = this.productGoodses;\r\n        for (let j = 0; j < ids.length; j++) {\r\n          for (let i = 0; i < productGoodses.length; i++) {\r\n            let materials = productGoodses[i].productGoodsMaterials;\r\n            for (let k = 0; k < materials.length; k++) {\r\n              if (materials[k].materialId == ids[j]) {\r\n                materials.splice(k, 1);\r\n                productGoodses[i].valid = false; //未使用状态\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    //列表用量发生变化 并计算金额\r\n    usageAmountBlur(item, _usageAmount) {\r\n      let productGoodses = this.productGoodses;\r\n      for (let i = 0; i < productGoodses.length; i++) {\r\n        let materials = productGoodses[i].productGoodsMaterials;\r\n        for (let k = 0; k < materials.length; k++) {\r\n          if (materials[k].materialId == item.materialId) {\r\n            materials[k].usageAmount = _usageAmount;\r\n            productGoodses[i].price +=\r\n              materials[k].usageAmount * materials[k].unitPrice;\r\n            console.log(productGoodses[i]);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    },\r\n    //单选框发生改变\r\n    skuRadioChange(elem, item, skuIndex) {\r\n      let list = this.productGoodses;\r\n      for (let i = 0; i < list.length; i++) {\r\n        list[i].defaultStatus = false;\r\n      }\r\n      item.defaultStatus = true;\r\n    },\r\n    routerGo() {\r\n      this.$router.go(-1);\r\n    },\r\n    routerback() {\r\n      if (this._type == \"edit\") {\r\n        this.$router.go(-1);\r\n      } else if (this._type == \"add\") {\r\n        this.$router.go(-2);\r\n      } else {\r\n        this.$router.go(-1);\r\n      }\r\n    },\r\n    //数组对象深拷贝\r\n    arrCopy(arr) {\r\n      let copy = [];\r\n      for (let i = 0; i < arr.length; i++) {\r\n        copy.push(JSON.parse(JSON.stringify(arr[i])));\r\n      }\r\n      return copy;\r\n    }\r\n  },\r\n\r\n  components: {\r\n    [NewSku.name]: NewSku,\r\n    [SingleMaterialDialog.name]: SingleMaterialDialog,\r\n    [SingleTechnologyDialog.name]: SingleTechnologyDialog\r\n  }\r\n};\r\n",{"version":3,"sources":["single_details.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA","file":"single_details.vue","sourceRoot":"src/views/product/format","sourcesContent":["<!--\r\n * @Description: In User Settings Edit\r\n * @Author: your name\r\n * @Date: 2019-07-01 15:20:22\r\n * @LastEditTime: 2019-07-01 15:20:22\r\n * @LastEditors: your name\r\n -->\r\n\r\n<template>\r\n  <div class=\"bg-fff item-margin\">\r\n    <el-form\r\n      class=\"item-form\"\r\n      :rules=\"rules\"\r\n      :model=\"filtersData\"\r\n      label-width=\"100px\"\r\n      size=\"small\"\r\n      ref=\"filtersForm\"\r\n      inline\r\n    >\r\n      <div>\r\n        当前商品分类：{{fullCateName}}\r\n        <el-button v-if=\"_type == 'add'\" @click=\"routerGo\" type=\"text\">切换分类</el-button>\r\n      </div>\r\n      <h5 class=\"tlogy-title\">基本信息</h5>\r\n      <el-form-item prop=\"name\" label=\"商品名称：\">\r\n        <el-input\r\n          class=\"input-w\"\r\n          placeholder=\"请输入内容\"\r\n          :disabled=\"showDisabled\"\r\n          v-model=\"filtersData.name\"\r\n        ></el-input>\r\n      </el-form-item>\r\n      <el-form-item prop=\"valid\" label=\"使用状态：\">\r\n        <el-select\r\n          class=\"input-w\"\r\n          placeholder=\"请选择\"\r\n          :disabled=\"showDisabled\"\r\n          v-model=\"filtersData.valid\"\r\n        >\r\n          <el-option\r\n            v-for=\"item in this.$common.getValidOptions()\"\r\n            :key=\"item.status_id\"\r\n            :label=\"item.status_name\"\r\n            :value=\"item.status_id\"\r\n          ></el-option>\r\n        </el-select>\r\n      </el-form-item>\r\n      <el-form-item class=\"single-cus-warp\" prop=\"cusCateIdentifier\" label=\"定制分类：\">\r\n        <el-cascader\r\n          :disabled=\"showDisabled\"\r\n          class=\"input-w\"\r\n          :options=\"classData\"\r\n          v-model=\"cateArr\"\r\n          @change=\"cascaderGet\"\r\n          :placeholder=\"cusPlaceholder\"\r\n          :show-all-levels=\"false\"\r\n          :props=\"props\"\r\n          change-on-select\r\n        ></el-cascader>\r\n      </el-form-item>\r\n      <!-- 商品基础内容 -->\r\n      <h5 class=\"tlogy-subtitle\">商品基础内容</h5>\r\n      <el-tabs v-model=\"activeName\" type=\"card\" class=\"basic-wrap\">\r\n        <el-tab-pane label=\"已选原料\" name=\"material\">\r\n          <!-- 原料table -->\r\n          <div class=\"item-cont\">\r\n            <el-button size=\"small\" :disabled=\"showDisabled\" @click=\"openAddMaterial\">选择原料</el-button>\r\n          </div>\r\n          <div class=\"mt-10\">\r\n            <el-form-item label=\"筛选分类：\">\r\n              <el-cascader\r\n                class=\"input-w\"\r\n                :options=\"attrClassData\"\r\n                v-model=\"materialAttrCateArr\"\r\n                :value=\"materialAttrCateArr\"\r\n                @change=\"materialAttrCascaderGet\"\r\n                :show-all-levels=\"false\"\r\n                :props=\"props\"\r\n              ></el-cascader>\r\n            </el-form-item>\r\n            <el-form-item label=\"综合搜索：\">\r\n              <el-input class=\"input-w\" placeholder=\"名称或编码\" v-model.trim=\"materialForm.searchWords\"></el-input>\r\n            </el-form-item>\r\n            <el-form-item>\r\n              <el-button @click=\"SPUSearch('material',materialForm)\">筛选</el-button>\r\n              <el-button @click=\"SPUReset('material',materialForm)\">重置</el-button>\r\n            </el-form-item>\r\n          </div>\r\n          <div class=\"item-table\">\r\n            <el-table\r\n              height=\"400\"\r\n              :data=\"materialTableListData\"\r\n              stripe\r\n              empty-text=\"暂无数据\"\r\n              header-align=\"center\"\r\n              header-row-class-name=\"item-table-header\"\r\n              :highlight-current-row=\"true\"\r\n            >\r\n              <el-table-column prop=\"materialCateName\" align=\"center\" label=\"分类\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"code\" align=\"center\" label=\"标准编码\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"name\" align=\"center\" label=\"原料名称\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"image\" align=\"center\" label=\"图片\" width=\"80\">\r\n                <template slot-scope=\"scope\">\r\n                  <img class=\"table-img-wh\" :src=\"scope.row.image\" alt>\r\n                </template>\r\n              </el-table-column>\r\n              <el-table-column prop=\"unitPrice\" align=\"center\" label=\"销售价格\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"usageAmount\" align=\"center\" label=\"用量\" min-width=\"120\">\r\n                <template slot-scope=\"scope\">\r\n                  <el-input\r\n                    v-enter-number\r\n                    type=\"number\"\r\n                    @blur=\"usageAmountBlur(scope.row,scope.row.usageAmount)\"\r\n                    :disabled=\"showDisabled\"\r\n                    v-model.number=\"scope.row.usageAmount\"\r\n                    placeholder=\"请输入\"\r\n                  ></el-input>\r\n                </template>\r\n              </el-table-column>\r\n              <el-table-column\r\n                fixed=\"right\"\r\n                label-class-name=\"text-center\"\r\n                class-name=\"text-center\"\r\n                align=\"center\"\r\n                label=\"操作\"\r\n                width=\"50\"\r\n              >\r\n                <template slot-scope=\"scope\">\r\n                  <el-button\r\n                    :disabled=\"showDisabled\"\r\n                    @click=\"removeMaterialAndTechnology(scope.row.materialId,'material')\"\r\n                    type=\"text\"\r\n                    size=\"small\"\r\n                  >删除</el-button>\r\n                </template>\r\n              </el-table-column>\r\n            </el-table>\r\n          </div>\r\n          <!-- 原料table end  -->\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"已选工艺\" name=\"technology\">\r\n          <!-- 工艺table  -->\r\n          <div class=\"item-cont\">\r\n            <el-button size=\"small\" :disabled=\"showDisabled\" @click=\"openAddTechnology\">选择工艺</el-button>\r\n          </div>\r\n          <div class=\"mt-10\">\r\n            <el-form-item label=\"筛选分类：\">\r\n              <el-cascader\r\n                class=\"input-w\"\r\n                :options=\"attrClassData\"\r\n                v-model=\"technologyAttrCateArr\"\r\n                :value=\"technologyAttrCateArr\"\r\n                @change=\"technologyAttrCascaderGet\"\r\n                :show-all-levels=\"false\"\r\n                :props=\"props\"\r\n              ></el-cascader>\r\n            </el-form-item>\r\n            <el-form-item label=\"综合搜索：\">\r\n              <el-input class=\"input-w\" placeholder=\"名称或编码\" v-model=\"technologyForm.searchWords\"></el-input>\r\n            </el-form-item>\r\n            <el-form-item>\r\n              <el-button @click=\"SPUSearch('technology',technologyForm)\">筛选</el-button>\r\n              <el-button @click=\"SPUReset('technology',technologyForm)\">重置</el-button>\r\n            </el-form-item>\r\n          </div>\r\n          <div class=\"item-table\">\r\n            <el-table\r\n              height=\"400\"\r\n              :data=\"technologyTableListData\"\r\n              stripe\r\n              empty-text=\"暂无数据\"\r\n              header-align=\"center\"\r\n              header-row-class-name=\"item-table-header\"\r\n              :highlight-current-row=\"true\"\r\n            >\r\n              <el-table-column prop=\"materialCateName\" align=\"center\" label=\"分类\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"code\" align=\"center\" label=\"标准编码\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"name\" align=\"center\" label=\"工艺名称\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"image\" align=\"center\" label=\"图片\" width=\"80\">\r\n                <template slot-scope=\"scope\">\r\n                  <img class=\"table-img-wh\" :src=\"scope.row.image\" alt>\r\n                </template>\r\n              </el-table-column>\r\n              <el-table-column prop=\"unitPrice\" align=\"center\" label=\"销售价格\" min-width=\"100\"></el-table-column>\r\n              <el-table-column prop=\"usageAmount\" align=\"center\" label=\"用量\" min-width=\"120\">\r\n                <template slot-scope=\"scope\">\r\n                  <el-input\r\n                    v-enter-number\r\n                    type=\"number\"\r\n                    @blur=\"usageAmountBlur(scope.row,scope.row.usageAmount)\"\r\n                    :disabled=\"showDisabled\"\r\n                    v-model.number=\"scope.row.usageAmount\"\r\n                    placeholder=\"请输入\"\r\n                  ></el-input>\r\n                </template>\r\n              </el-table-column>\r\n              <el-table-column\r\n                fixed=\"right\"\r\n                label-class-name=\"text-center\"\r\n                class-name=\"text-center\"\r\n                align=\"center\"\r\n                label=\"操作\"\r\n                width=\"50\"\r\n              >\r\n                <template slot-scope=\"scope\">\r\n                  <el-button\r\n                    :disabled=\"showDisabled\"\r\n                    @click=\"removeMaterialAndTechnology(scope.row.materialId,'technology')\"\r\n                    type=\"text\"\r\n                    size=\"small\"\r\n                  >删除</el-button>\r\n                </template>\r\n              </el-table-column>\r\n            </el-table>\r\n          </div>\r\n          <!-- 工艺table   End-->\r\n        </el-tab-pane>\r\n      </el-tabs>\r\n      <!-- 商品SKU -->\r\n      <h5 class=\"tlogy-title\">商品SKU</h5>\r\n      <div class=\"sku-wrap\">\r\n        <dl class=\"sku-item\" v-for=\"(item,index) in productGoodses\" :key=\"index\">\r\n          <dt @click.stop=\"skuEditItem(item,index)\">\r\n            <img :src=\"item.image\" class=\"sku-img-wh\">\r\n            <div class=\"abs-cont\">\r\n              <p>SKU价格：{{item.price}}</p>\r\n              <p>SKU名称：{{item.name}}</p>\r\n              <i @click.stop=\"skuIconRemove(item,index)\" class=\"el-icon-delete i-index\"></i>\r\n            </div>\r\n          </dt>\r\n          <dd class=\"mt-5\">\r\n            <el-radio\r\n              @change=\"skuRadioChange($event,item,index)\"\r\n              v-model=\"item.defaultStatus\"\r\n              :label=\"true\"\r\n            >设为默认</el-radio>\r\n          </dd>\r\n        </dl>\r\n        <nav\r\n          v-if=\"productGoodses.length <= 9 && _type != 'show'\"\r\n          @click=\"addSkuBtn\"\r\n          class=\"single-btn\"\r\n        >\r\n          <i class=\"el-icon-plus\"></i>\r\n        </nav>\r\n      </div>\r\n      <!-- 商品SKU end -->\r\n    </el-form>\r\n    <div class=\"item-footer\">\r\n      <el-button\r\n        v-if=\"_type == 'add'\"\r\n        size=\"small\"\r\n        @click=\"submitForm('filtersForm')\"\r\n        type=\"primary\"\r\n      >确定</el-button>\r\n      <el-button\r\n        v-else-if=\"_type == 'edit'\"\r\n        size=\"small\"\r\n        @click=\"submitEditForm('filtersForm')\"\r\n        type=\"primary\"\r\n      >修改</el-button>\r\n      <el-button size=\"small\" @click=\"routerback('filtersForm')\">取消</el-button>\r\n    </div>\r\n    <!-- SKU -->\r\n    <tp-new-sku\r\n      @setParentSKUData=\"getSubSKUData\"\r\n      @setParentEditSKUData=\"getSubEditSKUData\"\r\n      ref=\"skuRef\"\r\n    ></tp-new-sku>\r\n    <!-- 原料 setMaterialData 子向父穿的参数 setEchoData 父向子穿的参数  -->\r\n    <tp-material-dialog @setParentMaterialData=\"getSubMaterialList\" ref=\"materialDialogRef\"></tp-material-dialog>\r\n    <!-- 工艺 -->\r\n    <tp-technology-dialog @setParentTechnologyData=\"getSubTechnologyList\" ref=\"technologyDialogRef\"></tp-technology-dialog>\r\n  </div>\r\n</template>\r\n<script>\r\nimport SingleMaterialDialog from \"@/components/customAttribute/single_material_dialog\";\r\nimport SingleTechnologyDialog from \"@/components/customAttribute/single_technology_dialog\";\r\nimport NewSku from \"@/components/SKUAssembly/add_new_sku\";\r\n/**\r\n * TODO  一些地方用不掉... 深复制\r\n * 如优化 需去掉\r\n */\r\n/**\r\n * 父组件已选原料镜像\r\n */\r\nlet middlewareMaterialList = [];\r\n/**\r\n * 父组件已选工艺镜像\r\n */\r\nlet middlewareTechnologyList = [];\r\n/**\r\n * 原料和工艺数据合并生成的新数据\r\n */\r\nlet materialAndTechnologyList = [];\r\nlet cusCateType=false,cusTableType=false;\r\nexport default {\r\n  data() {\r\n    return {\r\n      filtersData: {},\r\n      activeName: \"material\", //切换\r\n      rules: {\r\n        //规则验证\r\n        valid: [{ required: true, message: \"请选择状态\", trigger: \"change\" }],\r\n        name: [{ required: true, message: \"请输入商品名称\", trigger: \"blur\" },\r\n        {max:24, message: \"最长24个汉字\", trigger: \"blur\" }]\r\n      },\r\n\r\n      editDisabled: false,\r\n      showDisabled: false,\r\n      materialTableListData: [], //原料table列表\r\n      technologyTableListData: [], //工艺 table 列表\r\n      fullCateName: \"\", //分类显示\r\n      //定制分类搜索\r\n      classData: [],\r\n      classList: [],\r\n      //属性分类数据\r\n      attrClassData: [],\r\n      attrListData: [],\r\n      //定制分类\r\n      cateArr: [],\r\n      //属性分类\r\n      materialAttrCateArr: [],\r\n      //工艺分类\r\n      technologyAttrCateArr: [],\r\n      props: {\r\n        value: \"id\",\r\n        label: \"name\",\r\n        children: \"children\"\r\n      },\r\n      //原料搜索字段\r\n      materialForm: {\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      },\r\n      //工艺搜索字段\r\n      technologyForm: {\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      },\r\n      _type: \"\",\r\n      _id: \"\",\r\n      //定制货品信息列表\r\n      productGoodses: [],\r\n      cusPlaceholder: \"请选择定制分类\",\r\n      setCateIdentifier:\"\",//后台获取的定制分类\r\n    };\r\n  },\r\n  created() {\r\n    this.init();\r\n    this.getClassData();\r\n    this.getQueryparams();\r\n  },\r\n  methods: {\r\n    init(){\r\n      middlewareMaterialList = [];\r\n      middlewareTechnologyList = [];\r\n      materialAndTechnologyList = [];\r\n      this.filtersData={};\r\n      this.materialTableListData=[]; //原料table列表\r\n      this.technologyTableListData=[];\r\n      this.productGoodses=[];\r\n      this.materialForm={\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      };\r\n      //工艺搜索字段\r\n      this.technologyForm={\r\n        materialCateId: \"\",\r\n        searchWords: \"\"\r\n      };\r\n      cusCateType=false;cusTableType=false;\r\n    },\r\n    getClassData() {\r\n      //分类类型（1：标准分类，2：定制分类，3：原料分类或者称为属性分类）\r\n      this.$common.getClassSelect(this, 2).then(res => {\r\n        this.classData = res.ztree;\r\n        this.classList = res.list;\r\n        cusCateType=true;\r\n        this.setCusCateName();\r\n      });\r\n      //获取属性分类  type 3\r\n      this.$common.getClassSelect(this, 3).then(res => {\r\n        this.attrClassData = res.ztree;\r\n        this.attrListData = res.list;\r\n\r\n      });\r\n    },\r\n    //定制分类\r\n    cascaderGet(e) {\r\n      let cateId = JSON.parse(JSON.stringify(e)).pop();\r\n      let obj = this.classList.find(item => item.id == cateId);\r\n      this.filtersData.cusCateIdentifier = obj.identifier;\r\n      this.filtersData.cusCateId = obj.id;\r\n      this.filtersData.cusCateName = obj.name;\r\n      this.filtersData.cusFullCateName = obj.fullCateName;\r\n    },\r\n    //原料属性分类\r\n    materialAttrCascaderGet(e) {\r\n      let cateId = JSON.parse(JSON.stringify(e)).pop();\r\n      let obj = this.attrListData.find(item => item.id == cateId);\r\n      this.materialForm.materialCateId = obj.id;\r\n      // this.materialForm.materialCateIdentifier = obj.identifier;\r\n    },\r\n    //工艺属性分类\r\n    technologyAttrCascaderGet(e) {\r\n      let cateId = JSON.parse(JSON.stringify(e)).pop();\r\n      let obj = this.attrListData.find(item => item.id == cateId);\r\n      this.technologyForm.materialCateId = obj.id;\r\n    },\r\n    //获取上页面参数\r\n    getQueryparams() {\r\n      let params = this.$route.query;\r\n      this._type = params._type;\r\n      this._id = params._id;\r\n      let itemStatus = this._type;\r\n      switch (itemStatus.toString()) {\r\n        case \"add\": //新增\r\n          this.editDisabled = false;\r\n          this.showDisabled = false;\r\n          this.fullCateName = params.fullCateName;\r\n          let filters = this.filtersData;\r\n          ({\r\n            cateId: filters.cateId,\r\n            cateName: filters.cateName,\r\n            cateIdentifier: filters.cateIdentifier,\r\n            fullCateName: filters.fullCateName\r\n          } = params);\r\n          break;\r\n        case \"edit\": //修改\r\n          this.editDisabled = true;\r\n          this.showDisabled = false;\r\n          this.getData();\r\n          break;\r\n        case \"show\": //查看\r\n          this.editDisabled = true;\r\n          this.showDisabled = true;\r\n          this.getData();\r\n          break;\r\n      }\r\n    },\r\n    //添加sku\r\n    addSkuBtn() {\r\n      if (middlewareMaterialList.length <= 0) {\r\n        this.$message.error(\"请选择原料\");\r\n        return false;\r\n      }\r\n      if (middlewareTechnologyList.length <= 0) {\r\n        this.$message.error(\"请选择工艺\");\r\n        return false;\r\n      }\r\n      let List = this.arrCopy(materialAndTechnologyList);\r\n      this.$refs.skuRef.popupInit(\"add\", List);\r\n    },\r\n    //获取SKU子组件返回的数据\r\n    getSubSKUData(skuData) {\r\n      this.productGoodses.push(skuData);\r\n      if (this.productGoodses.length == 1) {\r\n        this.productGoodses[0].defaultStatus = true;\r\n      }\r\n    },\r\n    //获取SKU子组件编辑后返回的数据\r\n    getSubEditSKUData(editSkuData, subType, subIndex) {\r\n      if (subType == \"edit\") {\r\n        this.productGoodses.splice(subIndex, 1, editSkuData);\r\n      }\r\n    },\r\n    //编辑当前的sku\r\n    skuEditItem(item, _index) {\r\n      if (middlewareMaterialList.length <= 0) {\r\n        this.$message.error(\"请选择原料\");\r\n        return false;\r\n      }\r\n      if (middlewareTechnologyList.length <= 0) {\r\n        this.$message.error(\"请选择工艺\");\r\n        return false;\r\n      }\r\n      let List = this.arrCopy(materialAndTechnologyList);\r\n      let skuItem = JSON.parse(JSON.stringify(item)),\r\n        skuIndex = _index;\r\n      this.$refs.skuRef.editPopupInit(\r\n        \"edit\",\r\n        List,\r\n        skuItem,\r\n        skuIndex,\r\n        this._type\r\n      );\r\n    },\r\n    //删除当前的SKU\r\n    skuIconRemove(item, _index) {\r\n      this.productGoodses.splice(_index, 1);\r\n    },\r\n    //添加原料\r\n    openAddMaterial() {\r\n      this.$refs.materialDialogRef.popupInit(\r\n        this.filtersData.cateIdentifier,\r\n        this._type,\r\n        this.arrCopy(middlewareMaterialList),\r\n        this.arrCopy(this.productGoodses)\r\n      );\r\n    },\r\n    //子组件传回的已选数据\r\n    getSubMaterialList(list, productGoodsesIds) {\r\n      console.log(list);\r\n      let subMaterialList = list;\r\n      //假如是新增的情况下 根本不需要做很多判断 直接放入\r\n      this.materialTableListData = subMaterialList;\r\n      middlewareMaterialList = [...subMaterialList];\r\n      materialAndTechnologyList = [\r\n        ...middlewareMaterialList,\r\n        ...middlewareTechnologyList\r\n      ];\r\n      this.SPUReset(\"material\", this.materialForm);\r\n      this.SPUSearch(\"material\", this.materialForm);\r\n      //删除已选SKU\r\n      this.arrRemoveSelectedSku(productGoodsesIds);\r\n    },\r\n    //添加工艺\r\n    openAddTechnology() {\r\n      //当点添加的时候 存个当前的数据\r\n      this.$refs.technologyDialogRef.popupInit(\r\n        this.filtersData.cateIdentifier,\r\n        this._type,\r\n        this.arrCopy(middlewareTechnologyList),\r\n        this.arrCopy(this.productGoodses)\r\n      );\r\n    },\r\n    //工艺添加成功后返回的数据\r\n    getSubTechnologyList(list, productGoodsesIds) {\r\n      let subMaterialList = list;\r\n      //假如是新增的情况下 根本不需要做很多判断 直接放入\r\n      this.technologyTableListData = subMaterialList;\r\n      middlewareTechnologyList = [...subMaterialList];\r\n      materialAndTechnologyList = [\r\n        ...middlewareMaterialList,\r\n        ...middlewareTechnologyList\r\n      ];\r\n      this.SPUReset(\"technology\", this.technologyForm);\r\n      this.SPUSearch(\"technology\", this.technologyForm);\r\n      //删除已选SKU\r\n      this.arrRemoveSelectedSku(productGoodsesIds);\r\n    },\r\n    //原料搜索及原料重置  TODO //以后和工艺合并\r\n    SPUSearch(SPUType, SPUForm) {\r\n      let filters = SPUForm;\r\n      if (filters.materialCateId == \"\" && filters.searchWords == \"\") {\r\n        if (SPUType == \"material\") {\r\n          this.materialTableListData = [...middlewareMaterialList];\r\n        } else {\r\n          this.technologyTableListData = [...middlewareTechnologyList];\r\n        }\r\n        filters = null;\r\n        return false;\r\n      }\r\n      //镜像数据 搜索时拿到全部的数据 也就是镜像数据;\r\n      let middleTableList =\r\n        SPUType == \"material\"\r\n          ? [...middlewareMaterialList]\r\n          : [...middlewareTechnologyList];\r\n      let filtersList = [];\r\n      if (!!filters.materialCateId) {\r\n        for (let i = 0; i < middleTableList.length; i++) {\r\n          if (\r\n            middleTableList[i].materialCateId.search(filters.materialCateId) !=\r\n            -1\r\n          ) {\r\n            filtersList.push(middleTableList[i]);\r\n           // break;\r\n          }\r\n        }\r\n      } else {\r\n        filtersList =\r\n          SPUType == \"material\"\r\n            ? [...middlewareMaterialList]\r\n            : [...middlewareTechnologyList];\r\n      }\r\n      let List = [];\r\n      if (!!filters.searchWords) {\r\n        for (let i = 0; i < filtersList.length; i++) {\r\n          let str = `${filtersList[i].name}${filtersList[i].code}`;\r\n          if (str.toUpperCase().search(filters.searchWords.toUpperCase()) != -1) {\r\n            List.push(filtersList[i]);\r\n           // break;\r\n          }\r\n        }\r\n      } else {\r\n        List = filtersList;\r\n      }\r\n      if (SPUType == \"material\") {\r\n        this.materialTableListData = List;\r\n      } else {\r\n        this.technologyTableListData = List;\r\n      }\r\n      filtersList = null;\r\n      List = null;\r\n      middleTableList = null;\r\n    },\r\n    SPUReset(SPUType, SPUForm) {\r\n      if (SPUType == \"material\") {\r\n        this.materialForm = {\r\n          materialCateId: \"\",\r\n          searchWords: \"\"\r\n        };\r\n        this.materialAttrCateArr = [];\r\n      } else {\r\n        this.technologyForm = {\r\n          materialCateId: \"\",\r\n          searchWords: \"\"\r\n        };\r\n        this.technologyAttrCateArr = [];\r\n      }\r\n    },\r\n    //新增\r\n    submitForm(formName) {\r\n      this.$refs[formName].validate(valid => {\r\n        if (valid) {\r\n          let filters = this.filtersData;\r\n          filters.productGoodses = [...this.productGoodses];\r\n          filters.productMaterials = [...materialAndTechnologyList];\r\n          console.log(this.filtersData);\r\n          this.request(\r\n            this.api.product.customizedProduct_save,\r\n            this.filtersData\r\n          ).then(data => {\r\n            this.$message.success(\"保存成功\");\r\n            setTimeout(() => {\r\n              this.routerback();\r\n            }, 500);\r\n          });\r\n        } else {\r\n          console.log(\"error submit!!\");\r\n          return false;\r\n        }\r\n      });\r\n    },\r\n    //修改保存\r\n    submitEditForm(formName) {\r\n      console.log(materialAndTechnologyList);\r\n      this.$refs[formName].validate(valid => {\r\n        if (valid) {\r\n          let filters = JSON.parse(JSON.stringify(this.filtersData));\r\n          //处理已选数组\r\n          let mirrorFilters = JSON.parse(JSON.stringify(this.filtersData));\r\n          let mirrorMTMR = mirrorFilters.productMaterials;\r\n          let MTMR = materialAndTechnologyList;\r\n          let deleteMTMR = []; //已删除已有ID的数据\r\n          for (let i = 0; i < mirrorMTMR.length; i++) {\r\n            let flag = false;\r\n            for (let k = 0; k < MTMR.length; k++) {\r\n              if (\r\n                mirrorMTMR[i].materialId == MTMR[k].materialId &&\r\n                MTMR[k].id != null\r\n              ) {\r\n                flag = true;\r\n              }\r\n            }\r\n            if (!flag) {\r\n              //此处是已删除的数据 但不正确 还要知道当前数据是不是删除后又新增的\r\n              mirrorMTMR[i].status = 9;\r\n              deleteMTMR.push(mirrorMTMR[i]);\r\n            }\r\n          }\r\n          //处理SKU  镜像sku数据\r\n          let mirrorPtGs = mirrorFilters.productGoodses;\r\n          //当前sku数据\r\n          let ptGs = [...this.productGoodses];\r\n          let deleteGoodses = [];\r\n          for (let i = 0; i < mirrorPtGs.length; i++) {\r\n            //镜像skuI\r\n            let mirrorPtGsMs = mirrorPtGs[i].productGoodsMaterials;\r\n            let parentFlag = false;\r\n            for (let k = 0; k < ptGs.length; k++) {\r\n              //skuk\r\n              let ptGsMs = ptGs[k].productGoodsMaterials;\r\n              //SKU已选数据判断循环\r\n              if (mirrorPtGs[i].id == ptGs[k].id && ptGs[k].id != null) {\r\n                parentFlag = true;\r\n                let deleteArr = [];\r\n                for (let o = 0; o < mirrorPtGsMs.length; o++) {\r\n                  let flag = false;\r\n                  for (let l = 0; l < ptGsMs.length; l++) {\r\n                    if (\r\n                      mirrorPtGsMs[o].materialId == ptGsMs[l].materialId &&\r\n                      ptGsMs[l].id != null\r\n                    ) {\r\n                      flag = true;\r\n                    }\r\n                  }\r\n                  if (!flag) {\r\n                    //此处是已删除的数据 但不正确 还要知道当前数据是不是删除后又新增的\r\n                    mirrorPtGsMs[o].status = 9;\r\n                    deleteArr.push(mirrorPtGsMs[o]);\r\n                  }\r\n                }\r\n                //当前的数据\r\n                ptGs[k].productGoodsMaterials = [...ptGsMs, ...deleteArr];\r\n              }\r\n              //子集循环完成\r\n            }\r\n            if (!parentFlag) {\r\n              mirrorPtGs[i].status = 9;\r\n              deleteGoodses.push(mirrorPtGs[i]);\r\n            }\r\n          }\r\n          filters.productGoodses = [...ptGs, ...deleteGoodses];\r\n          filters.productMaterials = [\r\n            ...materialAndTechnologyList,\r\n            ...deleteMTMR\r\n          ];\r\n          this.request(this.api.product.customizedProduct_save, filters).then(\r\n            data => {\r\n              this.$message.success(\"保存成功\");\r\n              setTimeout(() => {\r\n                this.routerback();\r\n              }, 500);\r\n            }\r\n          );\r\n        } else {\r\n          console.log(\"error submit!!\");\r\n          return false;\r\n        }\r\n      });\r\n    },\r\n    //删除原料数据\r\n    removeMaterialAndTechnology(itemId, listType) {\r\n      let names = [];\r\n      let productGoodses = this.productGoodses;\r\n      for (let i = 0; i < productGoodses.length; i++) {\r\n        let materials = productGoodses[i].productGoodsMaterials;\r\n        for (let k = 0; k < materials.length; k++) {\r\n          if (materials[k].materialId == itemId) {\r\n            names.push(productGoodses[i].name);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      if (names.length > 0) {\r\n        let strName = names.join(\"/\");\r\n        this.$confirm(`sku${strName}已使用到该项，是否确认删除!`, \"提示\", {\r\n          confirmButtonText: \"确定\",\r\n          cancelButtonText: \"取消\",\r\n          type: \"warning\"\r\n        })\r\n          .then(() => {\r\n            //删除操作的时候还需要判断 productGoodsMaterials 的长度 如果为0\r\n            for (let i = 0; i < productGoodses.length; i++) {\r\n              let materials = productGoodses[i].productGoodsMaterials;\r\n              for (let k = 0; k < materials.length; k++) {\r\n                if (materials[k].materialId == itemId) {\r\n                  materials.splice(k, 1);\r\n                  productGoodses[i].valid = false; //未使用状态\r\n                  break;\r\n                }\r\n              }\r\n            }\r\n            this.removeTableAndSku(itemId, listType);\r\n            this.$message({\r\n              type: \"success\",\r\n              message: \"删除成功!\"\r\n            });\r\n          })\r\n          .catch(() => {\r\n            this.$message({\r\n              type: \"info\",\r\n              message: \"已取消删除\"\r\n            });\r\n          });\r\n      } else {\r\n        //未有用到的原料工艺直接删除\r\n        this.removeTableAndSku(itemId, listType);\r\n      }\r\n    },\r\n    //回显数据\r\n    getData() {\r\n      this.request(this.api.product.customizedProduct_get, {\r\n        id: this._id\r\n      }).then(res => {\r\n        console.log(res);\r\n        let _data = res;\r\n        this.filtersData = JSON.parse(JSON.stringify(_data));\r\n        let Materials = [..._data.productMaterials];\r\n        this.fullCateName = _data.fullCateName;\r\n\r\n        let materialsTable = [],\r\n          technologyTable = [];\r\n        for (let i = 0; i < Materials.length; i++) {\r\n          if (Materials[i].type == 2) {\r\n            materialsTable.push(Materials[i]);\r\n          } else {\r\n            technologyTable.push(Materials[i]);\r\n          }\r\n        }\r\n        //回显列表数据；\r\n        this.materialTableListData = materialsTable;\r\n        middlewareMaterialList = [...materialsTable];\r\n        this.technologyTableListData = technologyTable;\r\n        middlewareTechnologyList = [...technologyTable];\r\n        materialAndTechnologyList = [\r\n          ...middlewareMaterialList,\r\n          ...middlewareTechnologyList\r\n        ];\r\n        this.productGoodses = [..._data.productGoodses];\r\n        this.setCateIdentifier = _data.cusCateIdentifier\r\n         if(!!_data.cusCateIdentifier){\r\n          cusTableType=true;\r\n          this.setCusCateName();\r\n        }\r\n\r\n      });\r\n    },\r\n    setCusCateName(){\r\n      if(cusCateType && cusTableType){\r\n        let arr=[];\r\n        let ids=this.setCateIdentifier.split('.');\r\n        let list=this.classList,listLen=list.length;\r\n        for (let k = 0; k < ids.length; k++) {\r\n          for (let i = 0; i < listLen; i++) {\r\n            if(ids[k] == list[i].code){\r\n              arr.push(list[i].id)\r\n              break;\r\n            }\r\n          }\r\n        }\r\n        this.cateArr=arr;\r\n      }\r\n    },\r\n    //删除操作列表和sku\r\n    removeTableAndSku(itemId, listType) {\r\n      if (listType == \"material\") {\r\n        let mlIndex = middlewareMaterialList.findIndex(\r\n          item => item.materialId == itemId\r\n        );\r\n        middlewareMaterialList.splice(mlIndex, 1);\r\n        this.materialTableListData.splice(mlIndex, 1);\r\n      } else {\r\n        let mrIndex = middlewareTechnologyList.findIndex(\r\n          item => item.materialId == itemId\r\n        );\r\n        middlewareTechnologyList.splice(mrIndex, 1);\r\n        this.technologyTableListData.splice(mrIndex, 1);\r\n      }\r\n      let mlmrIndex = materialAndTechnologyList.findIndex(\r\n        item => item.materialId == itemId\r\n      );\r\n      materialAndTechnologyList.splice(mlmrIndex, 1);\r\n    },\r\n    //数组删除SKU已选数据\r\n    arrRemoveSelectedSku(productGoodsesIds) {\r\n      let ids = new Set(productGoodsesIds);\r\n      if (ids.length > 0) {\r\n        let productGoodses = this.productGoodses;\r\n        for (let j = 0; j < ids.length; j++) {\r\n          for (let i = 0; i < productGoodses.length; i++) {\r\n            let materials = productGoodses[i].productGoodsMaterials;\r\n            for (let k = 0; k < materials.length; k++) {\r\n              if (materials[k].materialId == ids[j]) {\r\n                materials.splice(k, 1);\r\n                productGoodses[i].valid = false; //未使用状态\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    //列表用量发生变化 并计算金额\r\n    usageAmountBlur(item, _usageAmount) {\r\n      let productGoodses = this.productGoodses;\r\n      for (let i = 0; i < productGoodses.length; i++) {\r\n        let materials = productGoodses[i].productGoodsMaterials;\r\n        for (let k = 0; k < materials.length; k++) {\r\n          if (materials[k].materialId == item.materialId) {\r\n            materials[k].usageAmount = _usageAmount;\r\n            productGoodses[i].price +=\r\n              materials[k].usageAmount * materials[k].unitPrice;\r\n            console.log(productGoodses[i]);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    },\r\n    //单选框发生改变\r\n    skuRadioChange(elem, item, skuIndex) {\r\n      let list = this.productGoodses;\r\n      for (let i = 0; i < list.length; i++) {\r\n        list[i].defaultStatus = false;\r\n      }\r\n      item.defaultStatus = true;\r\n    },\r\n    routerGo() {\r\n      this.$router.go(-1);\r\n    },\r\n    routerback() {\r\n      if (this._type == \"edit\") {\r\n        this.$router.go(-1);\r\n      } else if (this._type == \"add\") {\r\n        this.$router.go(-2);\r\n      } else {\r\n        this.$router.go(-1);\r\n      }\r\n    },\r\n    //数组对象深拷贝\r\n    arrCopy(arr) {\r\n      let copy = [];\r\n      for (let i = 0; i < arr.length; i++) {\r\n        copy.push(JSON.parse(JSON.stringify(arr[i])));\r\n      }\r\n      return copy;\r\n    }\r\n  },\r\n\r\n  components: {\r\n    [NewSku.name]: NewSku,\r\n    [SingleMaterialDialog.name]: SingleMaterialDialog,\r\n    [SingleTechnologyDialog.name]: SingleTechnologyDialog\r\n  }\r\n};\r\n</script>\r\n<style lang=\"less\" scoped>\r\n.sku-wrap {\r\n  width: 100%;\r\n  display: flex;\r\n  justify-content: flex-start;\r\n  align-items: flex-start;\r\n  flex-wrap: wrap;\r\n\r\n  .single-btn {\r\n    width: 150px;\r\n    height: 150px;\r\n    border: 1px dashed #c0ccda;\r\n    border-radius: 6px;\r\n    text-align: center;\r\n    cursor: pointer;\r\n    line-height: 156px;\r\n\r\n    i {\r\n      font-size: 28px;\r\n      color: #8c939d;\r\n    }\r\n  }\r\n  .single-btn:hover {\r\n    border: 1px dashed blueviolet;\r\n  }\r\n}\r\n\r\n.sku-item {\r\n  margin-right: 10px;\r\n  dt {\r\n    cursor: pointer;\r\n    width: 150px;\r\n    height: 150px;\r\n    border-radius: 6px;\r\n    position: relative;\r\n    display: table-cell; //主要是这个属性\r\n    vertical-align: middle;\r\n    text-align: center;\r\n    box-shadow: 5px 5px 5px #999;\r\n    img {\r\n      border-radius: 6px;\r\n      height: 150px;\r\n      width: auto;\r\n      max-width: 150px;\r\n    }\r\n    .abs-cont {\r\n      text-align: left;\r\n      position: absolute;\r\n      left: 0;\r\n      top: 0;\r\n      font-size: 12px;\r\n      color: #ffffff;\r\n      padding: 4px 2px 4px 4px;\r\n      border-radius: 6px;\r\n      width: 100%;\r\n      height: 100%;\r\n      background-color: #000000;\r\n      opacity: 0.5;\r\n      display: none;\r\n      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);\r\n      i {\r\n        position: absolute;\r\n        right: 10px;\r\n        bottom: 10px;\r\n        cursor: pointer;\r\n        font-size: 18px;\r\n      }\r\n    }\r\n  }\r\n  dt:hover .abs-cont {\r\n    display: block;\r\n  }\r\n}\r\n</style>\r\n"]}]}